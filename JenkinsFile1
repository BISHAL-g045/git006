pipeline {
agent any
stages {
  
stage ("List Files") {
  steps {
bat 'cd'
bat 'dir /OD /T:W /A:-D'
  }
}

stage("Clone Git Repository") {
    steps {
        git branch: 'main', url: 'https://github.com/SUSIGUGH/docker02.git'
    }
}

  stage("Build Nodejs Image") {
    steps {
        bat 'docker build -t nodejs .'
        bat 'docker ps'
    }
}
  
  stage ("Delivery of Image to Docker Hub") {
    steps {
      bat 'sudo docker image tag nodejs susigugh/nodejs:1.0'
      bat 'sudo docker push susigugh/nodejs:1.0'
    }
  }
  
    stage ("Deployment to Kubernetes") {
    steps {
      bat 'chmod 400 <pemfile>'
      bat 'dir /OD /T:W /A:-D'
      bat 'scp -i <pemfile> -o StrictHostKeyChecking=no rep01.yml ec2-user@43.204.109.189:/home/ec2-user/'
      bat 'ssh -i <pemfile> -o StrictHostKeyChecking=no ec2-user@<IP> "kubectl delete -f rep01.yml"'
      bat 'ssh -i <pemfile> -o StrictHostKeyChecking=no ec2-user@<IP> "kubectl create -f rep01.yml"'
    }
  }
  
 
}
}
